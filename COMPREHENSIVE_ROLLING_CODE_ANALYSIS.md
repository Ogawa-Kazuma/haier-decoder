# Comprehensive Rolling Code Analysis Report

## Executive Summary

This report presents a detailed analysis of the rolling code authentication system used in the Haier washing machine protocol. The analysis reveals a sophisticated security mechanism with both strengths and potential vulnerabilities.

## Key Findings

### 1. Rolling Code System Overview

**System Type**: Challenge-Response Authentication with Rolling Codes
- **Challenges**: 8-byte random values generated by the machine
- **Responses**: 26-byte encrypted responses from the modem
- **Frequency**: Authentication occurs after each power cycle
- **Timing**: 3-6 second response time for authentication

### 2. Cryptographic Analysis

#### Challenge Generation
- **Format**: `00 12 10 02 00 01 [4-byte rolling code]`
- **Entropy**: 2.750 bits (moderate randomness)
- **Uniqueness**: 8 out of 9 challenges unique (1 duplicate detected)
- **Pattern**: No obvious sequential or linear patterns

#### Response Encryption
- **Format**: 26-byte encrypted responses
- **Entropy**: 4.3-4.6 bits (high randomness)
- **Uniqueness**: All responses unique
- **Algorithm**: Unknown encryption (likely proprietary)

#### Security Strengths
1. **High Response Entropy**: 4.3-4.6 bits indicates strong encryption
2. **Unique Responses**: No duplicate encrypted responses
3. **Non-sequential Challenges**: Challenges don't follow predictable patterns
4. **Session-based**: Authentication tied to power cycles

#### Security Weaknesses
1. **Duplicate Challenge**: One challenge (`0012100200013f80`) used twice
2. **Low Challenge Entropy**: 2.75 bits suggests limited randomness
3. **Fixed Format**: Challenge structure is predictable
4. **Power Cycle Dependency**: Authentication resets after power cycles

### 3. State Machine Analysis

#### Protocol States (21 unique states identified)
1. **POWER_RESET**: Power cycle initiation
2. **SESSION_START**: Session initialization
3. **HANDSHAKE_INIT/ACK**: Handshake protocol
4. **AUTH_CHALLENGE/RESPONSE**: Authentication exchange
5. **STATUS_RESPONSE**: Machine status updates
6. **HEARTBEAT_ACK**: Keep-alive messages
7. **COMPLEX_COMMAND**: Multi-parameter commands

#### State Transitions
- **Total Transitions**: 401
- **Unique Transitions**: 46
- **Most Common**: `DEVICE_ID -> HEARTBEAT_ACK` (40 occurrences)
- **Authentication Flow**: `HEARTBEAT_ACK -> AUTH_CHALLENGE -> AUTH_RESPONSE -> HEARTBEAT_ACK`

#### Power Cycle Impact
- **16 Power Cycles** detected
- **Average Duration**: 32-42 seconds per cycle
- **State Progression**: Consistent pattern across cycles
- **Authentication**: Present in 8 out of 16 cycles

### 4. Timing Analysis

#### Response Times
- **Challenge-Response**: 3-6 seconds average
- **Fast Transitions**: 114 transitions (0-5s)
- **Medium Transitions**: 13 transitions (5-30s)
- **Slow Transitions**: 1 transition (>30s)

#### State Durations
- **POWER_RESET**: Immediate (0s)
- **QUERY_ACK**: 0.25s average
- **STATUS_RESPONSE**: 0.5s average
- **HEARTBEAT_ACK**: Continuous

### 5. Protocol Structure

#### Message Format
```
FF FF [Length] [Type] [Sequence] [Command] [Payload] [CRC]
```

#### Authentication Messages
- **Challenge**: `FF FF 25 40 00 00 00 00 00 12 10 02 00 01 [Challenge]`
- **Response**: `FF FF 25 40 00 00 00 00 00 11 10 02 00 01 [Encrypted Response]`

#### Key Components
- **Header**: `FF FF` (protocol identifier)
- **Length**: Payload length
- **Type**: `40` (command/control frames)
- **Sequence**: 4-byte sequence number
- **Command**: Command identifier
- **Payload**: Variable-length data
- **CRC**: 3-byte checksum

### 6. Security Assessment

#### Attack Vectors

1. **Replay Attacks**
   - **Risk**: Medium
   - **Mitigation**: Rolling codes prevent simple replay
   - **Vulnerability**: Power cycle resets may allow replay

2. **Brute Force**
   - **Risk**: Low
   - **Challenge Space**: 2^32 possible values
   - **Response Space**: 2^208 possible values
   - **Timing**: 3-6 second response time limits attempts

3. **Cryptographic Analysis**
   - **Risk**: Medium
   - **Challenge Entropy**: Low (2.75 bits)
   - **Response Entropy**: High (4.3-4.6 bits)
   - **Algorithm**: Unknown (proprietary)

4. **Power Cycle Exploitation**
   - **Risk**: High
   - **Vulnerability**: Authentication resets after power cycles
   - **Impact**: Could allow session hijacking

#### Security Recommendations

1. **Immediate Actions**
   - Fix duplicate challenge generation
   - Increase challenge entropy
   - Implement challenge expiration

2. **Medium-term Improvements**
   - Add timestamp validation
   - Implement session persistence
   - Add rate limiting

3. **Long-term Enhancements**
   - Upgrade to stronger cryptographic algorithms
   - Implement mutual authentication
   - Add forward secrecy

### 7. Implementation Details

#### Rolling Code Algorithm (Inferred)
1. **Challenge Generation**: Machine generates 4-byte random value
2. **Challenge Transmission**: Sent to modem with fixed header
3. **Response Generation**: Modem encrypts challenge using unknown algorithm
4. **Response Transmission**: 26-byte encrypted response sent back
5. **Verification**: Machine verifies response (algorithm unknown)

#### Protocol Flow
1. **Power On**: `POWER_RESET` state
2. **Session Init**: `SESSION_START` -> `HANDSHAKE_INIT` -> `HANDSHAKE_ACK`
3. **Authentication**: `AUTH_CHALLENGE` -> `AUTH_RESPONSE`
4. **Operation**: `STATUS_RESPONSE` -> `HEARTBEAT_ACK` (continuous)
5. **Power Off**: `POWER_RESET` (cycle repeats)

### 8. Technical Specifications

#### Device Information
- **Model**: CEAB9UQ00
- **Firmware**: E++2.17
- **Serial**: 0021800078EHD5108DUZ00000002
- **IMEI**: 862817068367949

#### Protocol Constants
- **Header**: `FF FF`
- **Frame Type**: `40`
- **Challenge Command**: `25 40`
- **Response Command**: `25 40`
- **Heartbeat**: `4D 61`
- **Status Query**: `F3`

### 9. Conclusion

The Haier washing machine rolling code system demonstrates a sophisticated approach to device authentication with several security strengths:

**Strengths:**
- High entropy encrypted responses
- Non-sequential challenge generation
- Session-based authentication
- Comprehensive state machine

**Weaknesses:**
- Duplicate challenge vulnerability
- Low challenge entropy
- Power cycle dependency
- Unknown encryption algorithm

**Overall Assessment:** The system provides reasonable security for a consumer appliance but has vulnerabilities that could be exploited by determined attackers. The rolling code mechanism is more sophisticated than simple sequential counters but falls short of modern cryptographic standards.

**Recommendation:** Implement the security improvements outlined above to enhance the system's resistance to attack while maintaining compatibility with existing devices.

---

*Analysis completed on December 24, 2024*
*Total messages analyzed: 402*
*Power cycles analyzed: 16*
*Authentication sequences: 18*
